{{/* Flow Node - Individual branch in the flow diagram */}}
{{/* Expects: .branch (branch data), .modules (slice of module pages) */}}

{{ $branch := .branch }}
{{ $modules := .modules }}
{{ $pathId := .pathId }}

{{/* Determine primary access level for the branch */}}
{{ $accessLevel := "free" }}
{{ range $modules }}
  {{ if eq .Params.accessLevel "commercial" }}
    {{ $accessLevel = "commercial" }}
  {{ else if and (eq .Params.accessLevel "authorized") (ne $accessLevel "commercial") }}
    {{ $accessLevel = "authorized" }}
  {{ end }}
{{ end }}

{{/* Collect content types and free video thumbnails */}}
{{ $hasVideo := false }}
{{ $hasQuiz := false }}
{{ $hasExercise := false }}
{{ $hasCertificate := false }}
{{ $hasReading := false }}
{{ $hasCaseStudy := false }}
{{ $freeVideoThumbnails := slice }}

{{ range $modules }}
  {{ range .Params.content }}
    {{ if eq .type "video" }}
      {{ $hasVideo = true }}
      {{/* Collect thumbnails for free videos */}}
      {{ if eq .accessLevel "free" }}
        {{ with .videoUrl }}
          {{/* Extract YouTube video ID from embed URL */}}
          {{ $videoId := "" }}
          {{ if findRE "youtube\\.com/embed/([a-zA-Z0-9_-]+)" . }}
            {{ $videoId = replaceRE ".*youtube\\.com/embed/([a-zA-Z0-9_-]+).*" "$1" . }}
          {{ else if findRE "youtu\\.be/([a-zA-Z0-9_-]+)" . }}
            {{ $videoId = replaceRE ".*youtu\\.be/([a-zA-Z0-9_-]+).*" "$1" . }}
          {{ else if findRE "youtube\\.com.*v=([a-zA-Z0-9_-]+)" . }}
            {{ $videoId = replaceRE ".*youtube\\.com.*v=([a-zA-Z0-9_-]+).*" "$1" . }}
          {{ end }}
          {{ if $videoId }}
            {{ $thumbnail := dict "id" $videoId "title" $.title "url" (printf "https://img.youtube.com/vi/%s/mqdefault.jpg" $videoId) }}
            {{ $freeVideoThumbnails = $freeVideoThumbnails | append $thumbnail }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ if eq .type "quiz" }}{{ $hasQuiz = true }}{{ end }}
    {{ if eq .type "exercise" }}{{ $hasExercise = true }}{{ end }}
    {{ if eq .type "reading" }}{{ $hasReading = true }}{{ end }}
    {{ if eq .type "case-study" }}{{ $hasCaseStudy = true }}{{ end }}
  {{ end }}
  {{ if .Params.certificate.enabled }}
    {{ $hasCertificate = true }}
  {{ end }}
{{ end }}

<div class="flow-node access-{{ $accessLevel }}"
     data-branch-id="{{ $branch.id }}"
     data-branch-title="{{ $branch.title }}"
     {{ with $branch.prerequisite }}data-prerequisite="{{ . }}"{{ end }}
     {{ with $branch.prerequisites }}data-prerequisites="{{ delimit . "," }}"{{ end }}
     data-modules="{{ delimit $branch.modules "," }}"
     style="left: {{ $branch.x }}%; top: {{ $branch.y }}%;">

  <div class="flow-node-card">
    {{/* YouTube Video Thumbnails for free videos */}}
    {{ if $freeVideoThumbnails }}
    <div class="flow-node-thumbnails">
      {{ range first 2 $freeVideoThumbnails }}
      <div class="flow-node-thumbnail">
        <img src="{{ .url }}" alt="Video preview" loading="lazy">
        <div class="thumbnail-play-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <polygon points="5 3 19 12 5 21 5 3"/>
          </svg>
        </div>
      </div>
      {{ end }}
      {{ if gt (len $freeVideoThumbnails) 2 }}
      <div class="flow-node-thumbnail-more">+{{ sub (len $freeVideoThumbnails) 2 }} more</div>
      {{ end }}
    </div>
    {{ end }}

    <div class="flow-node-header">
      <h4 class="flow-node-title">{{ $branch.title }}</h4>
      <div class="flow-node-status">
        {{ if ne $accessLevel "free" }}
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
        </svg>
        {{ end }}
      </div>
    </div>

    {{ with $branch.description }}
    <p class="flow-node-description">{{ . }}</p>
    {{ end }}

    <div class="flow-node-content-types">
      {{ if $hasVideo }}
      <span class="content-type-badge video" title="Video content">â–¶</span>
      {{ end }}
      {{ if $hasQuiz }}
      <span class="content-type-badge quiz" title="Knowledge quiz">?</span>
      {{ end }}
      {{ if $hasExercise }}
      <span class="content-type-badge exercise" title="Interactive exercise">âš™</span>
      {{ end }}
      {{ if $hasCaseStudy }}
      <span class="content-type-badge case-study" title="Case study">ðŸ“‹</span>
      {{ end }}
      {{ if $hasReading }}
      <span class="content-type-badge reading" title="Reading material">ðŸ“–</span>
      {{ end }}
      {{ if $hasCertificate }}
      <span class="content-type-badge certificate" title="Certificate available">â˜…</span>
      {{ end }}
    </div>

    <div class="flow-node-modules">
      {{ len $modules }} module{{ if gt (len $modules) 1 }}s{{ end }}
    </div>
  </div>
</div>
